<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel | The Trishul Vista</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .admin-page {
      min-height: 86vh;
      padding: 26px 14px 44px;
      background:
        radial-gradient(circle at 8% 8%, rgba(46, 138, 188, 0.18), transparent 35%),
        radial-gradient(circle at 92% 86%, rgba(255, 153, 0, 0.17), transparent 33%),
        linear-gradient(135deg, #eef4ff 0%, #fff7eb 100%);
    }

    .admin-wrap {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .admin-card {
      background: #fff;
      border: 1px solid #dce8f3;
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(16, 42, 67, 0.1);
      padding: 16px;
    }

    .admin-title {
      margin: 0;
      color: #0f2f52;
      font-family: Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
    }

    .admin-sub {
      margin: 4px 0 0;
      color: #486581;
      font-size: 0.92rem;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .stat {
      background: #f8fbff;
      border: 1px solid #dce8f3;
      border-radius: 10px;
      padding: 12px;
    }

    .stat p {
      margin: 0;
    }

    .stat .label {
      color: #627d98;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .stat .value {
      margin-top: 6px;
      color: #102a43;
      font-size: 1.28rem;
      font-weight: 800;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items: end;
      margin-top: 10px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      color: #243b53;
      font-size: 0.84rem;
      font-weight: 700;
    }

    .field input,
    .field select {
      border: 1px solid #d8e2ed;
      border-radius: 8px;
      padding: 10px 11px;
      font: inherit;
      color: #102a43;
      background: #fff;
    }

    .tab-switch {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .panel-tab {
      border: 1px solid #d4e2ef;
      background: #f4f8fc;
      color: #355070;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
    }

    .panel-tab.active {
      background: #2e8abc;
      color: #fff;
      border-color: #2e8abc;
    }

    .booking-filter-switch {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .booking-filter-tab {
      border: 1px solid #d4e2ef;
      background: #f4f8fc;
      color: #355070;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.84rem;
      font-weight: 800;
      cursor: pointer;
    }

    .booking-filter-tab.active {
      background: #0f2f52;
      color: #fff;
      border-color: #0f2f52;
    }
    .booking-filter-tab .tab-notify {
      margin-left: 6px;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #d64545;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 800;
      padding: 0 5px;
      line-height: 1;
    }

    .panel-title {
      margin: 0 0 10px;
      color: #0f2f52;
      font-size: 1.12rem;
      font-family: Georgia, serif;
    }

    .list {
      display: grid;
      gap: 8px;
      max-height: 480px;
      overflow: auto;
      padding-right: 2px;
    }

    .item {
      border: 1px solid #dfeaf4;
      border-radius: 10px;
      padding: 10px;
      background: #fbfdff;
      display: grid;
      gap: 8px;
    }

    .item-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .item-id {
      margin: 0;
      color: #486581;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .badge {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.76rem;
      font-weight: 700;
      border: 1px solid transparent;
    }

    .badge.paid {
      background: #edfdf4;
      color: #0f6a3f;
      border-color: #bdeccc;
    }

    .badge.pending {
      background: #fff7e8;
      color: #9a6700;
      border-color: #ffe0aa;
    }

    .badge.approved {
      background: #edfdf4;
      color: #0f6a3f;
      border-color: #bdeccc;
    }

    .badge.awaiting {
      background: #fff4e6;
      color: #9a6700;
      border-color: #ffd8a8;
    }

    .meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      color: #334e68;
      font-size: 0.85rem;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .admin-bookings-table-wrap {
      border: 1px solid #dfeaf4;
      border-radius: 10px;
      overflow: auto;
      background: #fbfdff;
    }

    .admin-bookings-table {
      width: 100%;
      min-width: 1220px;
      border-collapse: collapse;
      color: #334e68;
      font-size: 0.84rem;
    }

    .admin-bookings-table th,
    .admin-bookings-table td {
      border-bottom: 1px solid #e6eff7;
      padding: 9px 8px;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
    }

    .admin-bookings-table th {
      background: #f2f8ff;
      color: #0f2f52;
      font-weight: 800;
      font-size: 0.79rem;
    }

    .admin-bookings-table .admin-address-cell {
      white-space: normal;
      min-width: 220px;
    }

    .admin-bookings-table .admin-actions-cell {
      white-space: nowrap;
    }

    .admin-bookings-table .admin-actions-cell .btn + .btn {
      margin-left: 6px;
    }

    .details-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.58);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 7050;
    }

    .details-popup.show {
      display: flex;
    }

    .details-box {
      width: min(760px, 96vw);
      max-height: 86vh;
      overflow: auto;
      background: #fff;
      border-radius: 12px;
      border: 1px solid #dce8f3;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.28);
      padding: 16px;
    }

    .details-box h4 {
      margin: 0 0 10px;
      color: #102a43;
      font-size: 1.08rem;
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      color: #334e68;
      font-size: 0.88rem;
    }

    .details-grid p {
      margin: 0;
    }

    .details-grid .full {
      grid-column: 1 / -1;
    }

    .details-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }

    .btn {
      border: 0;
      border-radius: 7px;
      padding: 7px 10px;
      font-size: 0.82rem;
      font-weight: 700;
      cursor: pointer;
    }

    .btn.edit {
      background: #2e8abc;
      color: #fff;
    }

    .btn.warn {
      background: #f59f00;
      color: #fff;
    }

    .btn.danger {
      background: #e64949;
      color: #fff;
    }

    .btn.approve {
      background: #2f9e44;
      color: #fff;
    }

    .empty {
      border: 1px dashed #d1deec;
      border-radius: 10px;
      padding: 18px 10px;
      text-align: center;
      color: #627d98;
      background: #f9fbfe;
    }

    .admin-msg {
      margin-top: 8px;
      padding: 9px 11px;
      border-radius: 8px;
      font-size: 0.88rem;
      display: none;
    }

    .admin-msg.success {
      display: block;
      background: #edfdf4;
      color: #0f6a3f;
      border: 1px solid #bdeccc;
    }

    .admin-msg.error {
      display: block;
      background: #fff1f0;
      color: #9f1d1d;
      border: 1px solid #ffc9c5;
    }

    .confirm-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.58);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 7000;
    }

    .confirm-popup.show {
      display: flex;
    }

    .confirm-box {
      width: min(430px, 95vw);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #dce8f3;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.28);
      padding: 16px;
    }

    .confirm-box h4 {
      margin: 0 0 8px;
      color: #102a43;
      font-size: 1.08rem;
    }

    .confirm-box p {
      margin: 0 0 14px;
      color: #486581;
      line-height: 1.5;
      font-size: 0.91rem;
    }

    .confirm-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .confirm-btn {
      border: 0;
      border-radius: 8px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.88rem;
    }

    .confirm-btn.cancel {
      background: #eef3f8;
      color: #2f4e6f;
    }

    .confirm-btn.ok {
      background: #e64949;
      color: #fff;
    }

    .admin-login {
      max-width: 420px;
      margin: 30px auto 0;
    }

    .admin-login h3 {
      margin: 0 0 10px;
      color: #0f2f52;
      font-family: Georgia, serif;
      font-size: 1.35rem;
    }

    .admin-reset-wrap {
      margin-top: 12px;
      border-top: 1px solid #dce8f3;
      padding-top: 12px;
    }

    .admin-reset-toggle {
      width: 100%;
      border: 1px solid #dce8f3;
      background: #f8fbff;
      color: #1f4068;
      border-radius: 8px;
      padding: 9px 11px;
      font-size: 0.84rem;
      font-weight: 700;
      cursor: pointer;
      text-align: left;
    }

    .admin-reset-form {
      display: none;
      margin-top: 10px;
      gap: 8px;
    }

    .admin-reset-form.show {
      display: grid;
    }

    .admin-actions-top {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .insight-head {
      margin: 0 0 8px;
      color: #0f2f52;
      font-family: Georgia, serif;
      font-size: 1.14rem;
    }

    .insight-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .insight-box {
      background: #f7fbff;
      border: 1px solid #d9e8f6;
      border-radius: 10px;
      padding: 11px;
    }

    .insight-label {
      margin: 0;
      color: #627d98;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .insight-value {
      margin: 5px 0 0;
      color: #102a43;
      font-size: 1.2rem;
      font-weight: 800;
    }

    .insight-sections {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .insight-panel {
      border: 1px solid #dce8f3;
      border-radius: 10px;
      background: #fbfdff;
      padding: 11px;
    }

    .insight-panel h4 {
      margin: 0 0 8px;
      color: #1f4068;
      font-size: 0.92rem;
    }

    .insight-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 6px;
      color: #334e68;
      font-size: 0.86rem;
    }

    .insight-list li {
      border: 1px solid #e4edf6;
      border-radius: 7px;
      background: #fff;
      padding: 7px 8px;
    }

    @media (max-width: 980px) {
      .stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 560px) {
      .stats {
        grid-template-columns: 1fr;
      }
      .meta {
        grid-template-columns: 1fr;
      }
      .insight-grid {
        grid-template-columns: 1fr;
      }
      .insight-sections {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-wrapper">
      <div class="header-logo-group">
        <img src="images/logo.png" alt="The Trishul Vista Logo" />
        <div>
          <h1>The Trishul Vista</h1>
          <p>Serenity Amongst Mountain's</p>
        </div>
      </div>

      <div class="hamburger" id="hamburgerBtn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
      </div>
      <nav id="mainNav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="aboutus.html">About Us</a></li>
          <li><a href="rooms.html">Rooms</a></li>
          <li><a href="booking.html">Booking</a></li>
          <li><a href="gallery.html">Gallery</a></li>
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="auth.html" id="loginLink">Login</a></li>
          <li id="userGreeting"></li>
          <li><a href="#" id="logoutLink" onclick="logout(); return false;">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="admin-page">
    <section class="admin-wrap" id="adminLoginView">
      <article class="admin-card admin-login">
        <h3>Admin Access</h3>
        <div class="field">
          <label for="adminEmail">Admin Email</label>
          <input id="adminEmail" type="email" placeholder="admin@trishulvista.com" />
        </div>
        <div class="field">
          <label for="adminPassword">Admin Password</label>
          <input id="adminPassword" type="password" placeholder="Enter password" />
        </div>
        <button class="dash-btn primary" id="adminLoginBtn" style="width:100%;margin-top:10px;" type="button" onclick="adminLogin()">Login as Admin</button>
        <p id="adminLoginMsg" class="admin-msg"></p>

        <div class="admin-reset-wrap">
          <button type="button" class="admin-reset-toggle" id="adminResetToggleBtn" onclick="toggleResetPasswordForm()">
            <i class="fas fa-key"></i> Reset Admin Password
          </button>
          <form id="adminResetForm" class="admin-reset-form" novalidate>
            <div class="field">
              <label for="currentAdminPassword">Current Password</label>
              <input id="currentAdminPassword" type="password" required />
            </div>
            <div class="field">
              <label for="newAdminPassword">New Password</label>
              <input id="newAdminPassword" type="password" minlength="6" required />
            </div>
            <div class="field">
              <label for="confirmAdminPassword">Confirm New Password</label>
              <input id="confirmAdminPassword" type="password" minlength="6" required />
            </div>
            <button class="dash-btn primary" type="submit" style="width:100%;">Update Password</button>
            <p id="adminResetMsg" class="admin-msg"></p>
          </form>
        </div>
      </article>
    </section>

    <section class="admin-wrap" id="adminDashboardView" style="display:none;">
      <article class="admin-card">
        <h2 class="admin-title">Admin Dashboard</h2>
        <p class="admin-sub">Manage bookings and registered users from one place.</p>
        <div class="admin-actions-top">
          <button class="btn warn" id="exportBookingsBtn" type="button" onclick="exportBookings()"><i class="fas fa-file-export"></i> Export Bookings (Excel)</button>
          <button class="btn danger" id="adminLogoutBtn" type="button" onclick="adminLogout()"><i class="fas fa-right-from-bracket"></i> Admin Logout</button>
        </div>
      </article>

      <section class="stats">
        <article class="stat"><p class="label">Total Bookings</p><p class="value" id="sBookings">0</p></article>
        <article class="stat"><p class="label">Paid Bookings</p><p class="value" id="sPaid">0</p></article>
        <article class="stat"><p class="label">Total Users</p><p class="value" id="sUsers">0</p></article>
        <article class="stat"><p class="label">Revenue</p><p class="value" id="sRevenue">INR 0</p></article>
      </section>

      <article class="admin-card">
        <div class="toolbar">
          <div class="field">
            <label for="searchInput">Search (name/email/booking ID)</label>
            <input id="searchInput" type="text" placeholder="Type to filter..." />
          </div>
        </div>
        <p id="adminMsg" class="admin-msg"></p>
      </article>

      <article class="admin-card">
        <div class="tab-switch">
          <button class="panel-tab active" type="button" data-panel="bookingsPanelWrap">Bookings</button>
          <button class="panel-tab" type="button" data-panel="usersPanelWrap">Registered Users</button>
        </div>
        <section id="bookingsPanelWrap">
          <h3 class="panel-title">Bookings</h3>
          <div class="booking-filter-switch">
            <button class="booking-filter-tab active" type="button" data-booking-filter="today">Today Booking</button>
            <button class="booking-filter-tab" type="button" data-booking-filter="next">Next Day Booking <span id="nextBookingNotify" class="tab-notify" style="display:none;">0</span></button>
            <button class="booking-filter-tab" type="button" data-booking-filter="past">Past Booking</button>
          </div>
          <div id="bookingsPanel" class="list"></div>
        </section>
        <section id="usersPanelWrap" style="display:none;">
          <h3 class="panel-title">Registered Users</h3>
          <div id="usersPanel" class="list"></div>
        </section>
      </article>

    </section>
  </main>

  <div id="confirmPopup" class="confirm-popup" aria-hidden="true">
    <div class="confirm-box">
      <h4>Confirm Action</h4>
      <p id="confirmPopupText">Are you sure?</p>
      <div class="confirm-actions">
        <button type="button" class="confirm-btn cancel" id="confirmPopupCancelBtn" onclick="closeConfirmPopup()">Cancel</button>
        <button type="button" class="confirm-btn ok" id="confirmPopupOkBtn" onclick="proceedConfirmAction()">Yes, Continue</button>
      </div>
    </div>
  </div>

  <div id="bookingDetailsPopup" class="details-popup" aria-hidden="true">
    <div class="details-box">
      <h4>Booking Details</h4>
      <div id="bookingDetailsContent" class="details-grid"></div>
      <div class="details-actions">
        <button type="button" class="confirm-btn ok" id="printBookingDetailsBtn">Print</button>
        <button type="button" class="confirm-btn cancel" id="closeBookingDetailsBtn">Close</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Copyright 2025 The Trishul Vista | All rights reserved.</p>
  </footer>

  <script>
    const ADMIN_EMAIL = "admin@trishulvista.com";
    const ADMIN_PASSWORD_DEFAULT = "Admin@123";
    const ADMIN_PASSWORD_KEY = "trishulAdminPassword";

    const adminLoginView = document.getElementById("adminLoginView");
    const adminDashboardView = document.getElementById("adminDashboardView");
    const adminLoginMsg = document.getElementById("adminLoginMsg");
    const adminResetMsg = document.getElementById("adminResetMsg");
    const adminResetForm = document.getElementById("adminResetForm");
    const adminMsg = document.getElementById("adminMsg");
    const bookingsPanel = document.getElementById("bookingsPanel");
    const usersPanel = document.getElementById("usersPanel");
    const searchInput = document.getElementById("searchInput");
    const panelTabs = document.querySelectorAll(".panel-tab");
    const bookingFilterTabs = document.querySelectorAll(".booking-filter-tab");
    const bookingsPanelWrap = document.getElementById("bookingsPanelWrap");
    const usersPanelWrap = document.getElementById("usersPanelWrap");
    const nextBookingNotify = document.getElementById("nextBookingNotify");
    const confirmPopup = document.getElementById("confirmPopup");
    const confirmPopupText = document.getElementById("confirmPopupText");
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const logoutLink = document.getElementById("logoutLink");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminResetToggleBtn = document.getElementById("adminResetToggleBtn");
    const exportBookingsBtn = document.getElementById("exportBookingsBtn");
    const adminLogoutBtn = document.getElementById("adminLogoutBtn");
    const confirmPopupCancelBtn = document.getElementById("confirmPopupCancelBtn");
    const confirmPopupOkBtn = document.getElementById("confirmPopupOkBtn");
    const bookingDetailsPopup = document.getElementById("bookingDetailsPopup");
    const bookingDetailsContent = document.getElementById("bookingDetailsContent");
    const printBookingDetailsBtn = document.getElementById("printBookingDetailsBtn");
    const closeBookingDetailsBtn = document.getElementById("closeBookingDetailsBtn");
    const NEXT_BOOKING_NOTIFY_SEEN_KEY = "trishulAdminNextBookingNotifySeenAt";
    let currentBookingFilter = "today";
    let confirmAction = null;
    let currentBookingForPrint = null;

    function getAdminPassword() {
      const fromStorage = localStorage.getItem(ADMIN_PASSWORD_KEY);
      if (!fromStorage) {
        localStorage.setItem(ADMIN_PASSWORD_KEY, ADMIN_PASSWORD_DEFAULT);
        return ADMIN_PASSWORD_DEFAULT;
      }
      return fromStorage;
    }

    function toggleResetPasswordForm() {
      clearMsg(adminResetMsg);
      adminResetForm.classList.toggle("show");
    }
    window.toggleResetPasswordForm = toggleResetPasswordForm;

    function showMsg(el, type, text) {
      el.className = `admin-msg ${type}`;
      el.textContent = text;
    }

    function clearMsg(el) {
      el.className = "admin-msg";
      el.textContent = "";
    }

    function openConfirmPopup(message, actionFn) {
      confirmPopupText.textContent = message;
      confirmAction = actionFn;
      confirmPopup.classList.add("show");
      confirmPopup.setAttribute("aria-hidden", "false");
    }

    function closeConfirmPopup() {
      confirmPopup.classList.remove("show");
      confirmPopup.setAttribute("aria-hidden", "true");
      confirmAction = null;
    }

    function proceedConfirmAction() {
      if (typeof confirmAction === "function") {
        confirmAction();
      }
      closeConfirmPopup();
    }

    function closeBookingDetailsPopup() {
      bookingDetailsPopup.classList.remove("show");
      bookingDetailsPopup.setAttribute("aria-hidden", "true");
      bookingDetailsContent.innerHTML = "";
      currentBookingForPrint = null;
    }

    function openBookingDetails(id) {
      const booking = getBookings().find((b) => b.id === id);
      if (!booking) return;
      currentBookingForPrint = booking;
      const bookingApproved = String(booking.approvalStatus || "Pending").toLowerCase() === "approved" ? "Approved" : "Pending";
      const paymentApproved = isPaymentApproved(booking) ? "Approved" : (booking.paymentStatus || "Pending");
      const totalAmount = Number(booking.total || 0);
      const advancePaid = Number(booking.advancePaid || Math.min(500, totalAmount));
      const balanceDue = Number(booking.balanceDue != null ? booking.balanceDue : Math.max(totalAmount - advancePaid, 0));

      bookingDetailsContent.innerHTML = `
        <p><strong>Booking No:</strong> ${booking.bookingNo || "-"}</p>
        <p><strong>Booking ID:</strong> ${booking.id || "-"}</p>
        <p><strong>Name:</strong> ${booking.guestName || "-"}</p>
        <p><strong>Email:</strong> ${booking.email || "-"}</p>
        <p><strong>Phone:</strong> ${booking.phone || "-"}</p>
        <p><strong>Room:</strong> ${booking.roomType || "-"}</p>
        <p><strong>Guests:</strong> ${booking.guests || "-"}</p>
        <p><strong>Check-in:</strong> ${booking.checkIn || "-"}</p>
        <p><strong>Check-out:</strong> ${booking.checkOut || "-"}</p>
        <p><strong>Nights:</strong> ${booking.nights || "-"}</p>
        <p><strong>Total:</strong> INR ${totalAmount.toLocaleString("en-IN")}</p>
        <p><strong>Advance Paid:</strong> INR ${advancePaid.toLocaleString("en-IN")}</p>
        <p><strong>Balance Due:</strong> INR ${balanceDue.toLocaleString("en-IN")}</p>
        <p><strong>Booking Status:</strong> ${bookingApproved}</p>
        <p><strong>Payment Status:</strong> ${paymentApproved}</p>
        <p class="full"><strong>Address:</strong> ${booking.address || "-"}</p>
        <p class="full"><strong>Special Request:</strong> ${booking.specialRequest || "-"}</p>
      `;
      bookingDetailsPopup.classList.add("show");
      bookingDetailsPopup.setAttribute("aria-hidden", "false");
    }

    function printBookingDetails() {
      if (!currentBookingForPrint) return;
      const booking = currentBookingForPrint;
      const totalAmount = Number(booking.total || 0);
      const advancePaid = Number(booking.advancePaid || Math.min(500, totalAmount));
      const balanceDue = Number(booking.balanceDue != null ? booking.balanceDue : Math.max(totalAmount - advancePaid, 0));
      const paymentStatus = isPaymentApproved(booking) ? "Approved" : (booking.paymentStatus || "Pending");
      const bookingStatus = String(booking.approvalStatus || "Pending").toLowerCase() === "approved" ? "Approved" : "Pending";

      const printWindow = window.open("", "_blank", "width=900,height=700");
      if (!printWindow) return;
      const printableHtml = [
        "<html>",
        "<head>",
        "<title>Booking Details - " + (booking.id || "-") + "</title>",
        "<style>",
        "body { font-family: Arial, sans-serif; margin: 20px; color: #1f2937; }",
        "h2 { margin: 0 0 14px; }",
        "table { width: 100%; border-collapse: collapse; font-size: 14px; }",
        "td { border: 1px solid #d1d5db; padding: 8px 10px; vertical-align: top; }",
        "td.label { width: 32%; font-weight: 700; background: #f9fafb; }",
        "</style>",
        "</head>",
        "<body>",
        "<h2>The Trishul Vista - Booking Details</h2>",
        "<table>",
        "<tr><td class=\"label\">Booking No</td><td>" + (booking.bookingNo || "-") + "</td></tr>",
        "<tr><td class=\"label\">Booking ID</td><td>" + (booking.id || "-") + "</td></tr>",
        "<tr><td class=\"label\">Guest Name</td><td>" + (booking.guestName || "-") + "</td></tr>",
        "<tr><td class=\"label\">Email</td><td>" + (booking.email || "-") + "</td></tr>",
        "<tr><td class=\"label\">Phone</td><td>" + (booking.phone || "-") + "</td></tr>",
        "<tr><td class=\"label\">Room</td><td>" + (booking.roomType || "-") + "</td></tr>",
        "<tr><td class=\"label\">Guests</td><td>" + (booking.guests || "-") + "</td></tr>",
        "<tr><td class=\"label\">Check-in</td><td>" + (booking.checkIn || "-") + "</td></tr>",
        "<tr><td class=\"label\">Check-out</td><td>" + (booking.checkOut || "-") + "</td></tr>",
        "<tr><td class=\"label\">Nights</td><td>" + (booking.nights || "-") + "</td></tr>",
        "<tr><td class=\"label\">Total Amount</td><td>INR " + totalAmount.toLocaleString("en-IN") + "</td></tr>",
        "<tr><td class=\"label\">Advance Paid</td><td>INR " + advancePaid.toLocaleString("en-IN") + "</td></tr>",
        "<tr><td class=\"label\">Balance Due</td><td>INR " + balanceDue.toLocaleString("en-IN") + "</td></tr>",
        "<tr><td class=\"label\">Booking Status</td><td>" + bookingStatus + "</td></tr>",
        "<tr><td class=\"label\">Payment Status</td><td>" + paymentStatus + "</td></tr>",
        "<tr><td class=\"label\">Address</td><td>" + (booking.address || "-") + "</td></tr>",
        "<tr><td class=\"label\">Special Request</td><td>" + (booking.specialRequest || "-") + "</td></tr>",
        "</table>",
        "</body>",
        "</html>"
      ].join("");
      printWindow.document.write(printableHtml);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    window.closeConfirmPopup = closeConfirmPopup;
    window.proceedConfirmAction = proceedConfirmAction;

    function getBookings() {
      return JSON.parse(localStorage.getItem("trishulBookings") || "[]");
    }

    function getUsers() {
      return JSON.parse(localStorage.getItem("registeredUsers") || "[]");
    }

    function refreshStats() {
      const bookings = getBookings();
      const users = getUsers();
      const paid = bookings.filter((b) => {
        const status = String(b.paymentStatus || "").toLowerCase();
        return status === "paid" || status === "approved";
      }).length;
      const revenue = bookings.reduce((sum, b) => sum + Number(b.total || 0), 0);

      document.getElementById("sBookings").textContent = String(bookings.length);
      document.getElementById("sPaid").textContent = String(paid);
      document.getElementById("sUsers").textContent = String(users.length);
      document.getElementById("sRevenue").textContent = `INR ${revenue.toLocaleString("en-IN")}`;
    }

    function parseLocalDate(value) {
      if (!value) return null;
      const parts = String(value).split("-").map(Number);
      if (parts.length !== 3 || parts.some(Number.isNaN)) return null;
      const [year, month, day] = parts;
      const dt = new Date(year, month - 1, day);
      dt.setHours(0, 0, 0, 0);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function isPaymentApproved(booking) {
      const status = String((booking && booking.paymentStatus) || "").toLowerCase();
      return status === "paid" || status === "approved";
    }

    function updateNextBookingNotification() {
      if (!nextBookingNotify) return;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const seenAt = Number(localStorage.getItem(NEXT_BOOKING_NOTIFY_SEEN_KEY) || 0);
      const newNextBookingsCount = getBookings().filter((b) => {
        const checkInDate = parseLocalDate(b.checkIn);
        const createdAt = Number(b.createdAt || String(b.id || "").replace("TV-", "") || 0);
        return !!checkInDate && checkInDate > today && createdAt > seenAt;
      }).length;

      if (newNextBookingsCount > 0) {
        nextBookingNotify.style.display = "inline-flex";
        nextBookingNotify.textContent = String(newNextBookingsCount);
      } else {
        nextBookingNotify.style.display = "none";
      }
    }

    function renderBookings() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const q = (searchInput.value || "").trim().toLowerCase();
      const bookings = getBookings().filter((b) => {
        const checkInDate = parseLocalDate(b.checkIn);
        const checkOutDate = parseLocalDate(b.checkOut);
        let bookingFilterMatch = true;

        if (currentBookingFilter === "past") {
          bookingFilterMatch = !!checkOutDate && checkOutDate <= today;
        } else if (currentBookingFilter === "today") {
          bookingFilterMatch = !!checkInDate && !!checkOutDate && checkInDate <= today && checkOutDate > today;
        } else if (currentBookingFilter === "next") {
          bookingFilterMatch = !!checkInDate && checkInDate > today;
        }

        const searchMatch =
          !q ||
          String(b.id || "").toLowerCase().includes(q) ||
          String(b.guestName || "").toLowerCase().includes(q) ||
          String(b.email || "").toLowerCase().includes(q);
        return bookingFilterMatch && searchMatch;
      });

      bookingsPanel.innerHTML = "";
      if (!bookings.length) {
        const title =
          currentBookingFilter === "past"
            ? "No past bookings found."
            : currentBookingFilter === "next"
            ? "No next day bookings found."
            : "No today bookings found.";
        bookingsPanel.innerHTML = `<div class="empty">${title}</div>`;
        return;
      }

      const sorted = [...bookings].sort((a, b) => {
        const noA = Number(a.bookingNo || 0);
        const noB = Number(b.bookingNo || 0);
        if (noA && noB) return noA - noB;
        const timeA = Number(a.createdAt || String(a.id || "").replace("TV-", "") || 0);
        const timeB = Number(b.createdAt || String(b.id || "").replace("TV-", "") || 0);
        return timeA - timeB;
      });
      const rows = sorted.map((b) => {
        const paymentApproved = isPaymentApproved(b);
        const isApproved = String(b.approvalStatus || "Approved").toLowerCase() === "approved";
        const bookingNumber = Number(b.bookingNo || 0) || "-";
        const actionHtml =
          currentBookingFilter === "past"
            ? `<span style="color:#627d98;font-size:0.8rem;font-weight:700;">Disabled</span>`
            : `${!isApproved ? `<button class="btn approve" type="button" data-action="approve-booking" data-id="${b.id || ""}">Approve Booking</button>` : ""}
               ${!paymentApproved ? `<button class="btn approve" type="button" data-action="approve-payment" data-id="${b.id || ""}">Approve Payment</button>` : ""}
               <button class="btn danger" type="button" data-action="delete-booking" data-id="${b.id || ""}">Delete</button>
               <button class="btn edit" type="button" data-action="view-details" data-id="${b.id || ""}">Details</button>`;
        return `
          <tr>
            <td>${bookingNumber}</td>
            <td>${b.id || "-"}</td>
            <td>${b.guestName || "-"}</td>
            <td>${b.roomType || "-"}</td>
            <td>${b.checkIn || "-"}</td>
            <td>${b.checkOut || "-"}</td>
            <td>INR ${Number(b.total || 0).toLocaleString("en-IN")}</td>
            <td class="admin-actions-cell">${actionHtml}</td>
          </tr>
        `;
      }).join("");

      bookingsPanel.innerHTML = `
        <div class="admin-bookings-table-wrap">
          <table class="admin-bookings-table">
            <thead>
              <tr>
                <th>No</th>
                <th>Booking ID</th>
                <th>Name</th>
                <th>Room</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;

      bookingsPanel.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.dataset.action;
          const id = btn.dataset.id;
          if (!id) return;
          if (action === "approve-booking") approveBooking(id);
          if (action === "approve-payment") approvePayment(id);
          if (action === "delete-booking") deleteBooking(id);
          if (action === "view-details") openBookingDetails(id);
        });
      });
    }

    function approveBooking(id) {
      openConfirmPopup("Approve this booking request?", () => {
        const all = getBookings();
        const index = all.findIndex((b) => b.id === id);
        if (index === -1) return;
        all[index].approvalStatus = "Approved";
        all[index].approvedAt = new Date().toISOString();
        localStorage.setItem("trishulBookings", JSON.stringify(all));
        showMsg(adminMsg, "success", "Booking approved successfully.");
        refreshAdminData();
      });
    }

    function approvePayment(id) {
      openConfirmPopup("Approve this booking payment?", () => {
        const all = getBookings();
        const index = all.findIndex((b) => b.id === id);
        if (index === -1) return;
        all[index].paymentStatus = "Approved";
        all[index].paymentAt = new Date().toISOString();
        if (!all[index].paymentMethod) all[index].paymentMethod = "QR";
        localStorage.setItem("trishulBookings", JSON.stringify(all));
        showMsg(adminMsg, "success", "Payment approved successfully.");
        refreshAdminData();
      });
    }

    function renderUsers() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const users = getUsers().filter((u) => {
        if (!q) return true;
        return String(u.name || "").toLowerCase().includes(q) || String(u.email || "").toLowerCase().includes(q);
      });
      usersPanel.innerHTML = "";
      if (!users.length) {
        usersPanel.innerHTML = `<div class="empty">No users found.</div>`;
        return;
      }

      users.forEach((u, idx) => {
        const card = document.createElement("article");
        card.className = "item";
        card.innerHTML = `
          <div class="item-top">
            <p class="item-id">${u.name || "-"} (${idx + 1})</p>
          </div>
          <div class="meta">
            <p><strong>Email:</strong> ${u.email || "-"}</p>
            <p><strong>Phone:</strong> ${u.phone || "-"}</p>
            <p style="grid-column: 1 / -1;"><strong>Address:</strong> ${u.address || "-"}</p>
          </div>
          <div class="actions">
            <button class="btn danger" type="button" data-action="delete-user" data-email="${u.email || ""}">Delete User</button>
          </div>
        `;
        usersPanel.appendChild(card);
      });

      usersPanel.querySelectorAll("button[data-action='delete-user']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const email = btn.dataset.email;
          if (!email) return;
          deleteUser(email);
        });
      });
    }

    function deleteBooking(id) {
      openConfirmPopup("Delete this booking permanently?", () => {
        const all = getBookings().filter((b) => b.id !== id);
        localStorage.setItem("trishulBookings", JSON.stringify(all));
        showMsg(adminMsg, "success", "Booking deleted successfully.");
        refreshAdminData();
      });
    }

    function deleteUser(email) {
      openConfirmPopup("Delete this user account?", () => {
        const users = getUsers().filter((u) => String(u.email || "").toLowerCase() !== String(email).toLowerCase());
        localStorage.setItem("registeredUsers", JSON.stringify(users));
        showMsg(adminMsg, "success", "User deleted successfully.");
        refreshAdminData();
      });
    }

    function exportBookings() {
      const data = getBookings();
      if (!data.length) {
        showMsg(adminMsg, "error", "No bookings available to export.");
        return;
      }

      const headers = [
        "Booking ID",
        "Guest Name",
        "Phone",
        "Email",
        "Address",
        "Room Type",
        "Guests",
        "Check-in",
        "Check-out",
        "Nights",
        "Offer Discount (%)",
        "Total (INR)",
        "Payment Status",
        "Approval Status",
        "Payment Method",
        "Payment Date",
        "Special Request"
      ];

      const escapeCsv = (value) => {
        const text = String(value == null ? "" : value);
        return `"${text.replace(/"/g, '""')}"`;
      };

      const rows = data.map((b) => [
        b.id || "",
        b.guestName || "",
        b.phone || "",
        b.email || "",
        b.address || "",
        b.roomType || "",
        b.guests || "",
        b.checkIn || "",
        b.checkOut || "",
        b.nights || "",
        b.offerDiscount || 0,
        b.total || 0,
        b.paymentStatus || "Pending",
        b.approvalStatus || "Approved",
        b.paymentMethod || "",
        b.paymentAt ? new Date(b.paymentAt).toLocaleString("en-IN") : "",
        b.specialRequest || ""
      ]);

      const csv = [headers, ...rows].map((row) => row.map(escapeCsv).join(",")).join("\r\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `trishul-bookings-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showMsg(adminMsg, "success", "Bookings exported in Excel format (.csv).");
    }

    function refreshAdminData() {
      clearMsg(adminMsg);
      refreshStats();
      renderBookings();
      renderUsers();
      updateNextBookingNotification();
    }

    function switchPanel(panelId) {
      panelTabs.forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.panel === panelId);
      });
      bookingsPanelWrap.style.display = panelId === "bookingsPanelWrap" ? "block" : "none";
      usersPanelWrap.style.display = panelId === "usersPanelWrap" ? "block" : "none";
    }

    function adminLogin() {
      clearMsg(adminLoginMsg);
      const email = document.getElementById("adminEmail").value.trim().toLowerCase();
      const password = document.getElementById("adminPassword").value;
      if (!email || !password) {
        showMsg(adminLoginMsg, "error", "Please enter email and password.");
        return;
      }
      if (email !== ADMIN_EMAIL || password !== getAdminPassword()) {
        showMsg(adminLoginMsg, "error", "Invalid admin credentials.");
        return;
      }
      adminLoginView.style.display = "none";
      adminDashboardView.style.display = "grid";
      refreshAdminData();
    }

    function adminLogout() {
      window.location.href = "index.html";
    }

    [searchInput].forEach((el) => {
      el.addEventListener("input", refreshAdminData);
      el.addEventListener("change", refreshAdminData);
    });

    if (adminLoginBtn) adminLoginBtn.addEventListener("click", adminLogin);
    if (adminResetToggleBtn) adminResetToggleBtn.addEventListener("click", toggleResetPasswordForm);
    if (exportBookingsBtn) exportBookingsBtn.addEventListener("click", exportBookings);
    if (adminLogoutBtn) adminLogoutBtn.addEventListener("click", adminLogout);
    if (confirmPopupCancelBtn) confirmPopupCancelBtn.addEventListener("click", closeConfirmPopup);
    if (confirmPopupOkBtn) confirmPopupOkBtn.addEventListener("click", proceedConfirmAction);
    if (hamburgerBtn) hamburgerBtn.addEventListener("click", toggleMenu);
    if (logoutLink) {
      logoutLink.addEventListener("click", (event) => {
        event.preventDefault();
        logout();
      });
    }

    panelTabs.forEach((tab) => {
      tab.addEventListener("click", () => switchPanel(tab.dataset.panel));
    });

    bookingFilterTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        currentBookingFilter = tab.dataset.bookingFilter || "today";
        bookingFilterTabs.forEach((btn) => {
          btn.classList.toggle("active", btn === tab);
        });
        if (currentBookingFilter === "next") {
          localStorage.setItem(NEXT_BOOKING_NOTIFY_SEEN_KEY, String(Date.now()));
        }
        updateNextBookingNotification();
        renderBookings();
      });
    });

    function closeMobileMenu() {
      const ul = document.querySelector("nav#mainNav ul");
      const hamburger = document.querySelector(".hamburger");
      ul.classList.remove("show");
      hamburger.classList.remove("active");
      document.body.classList.remove("menu-open");
    }

    function toggleMenu() {
      const ul = document.querySelector("nav#mainNav ul");
      const hamburger = document.querySelector(".hamburger");
      const isOpen = ul.classList.toggle("show");
      hamburger.classList.toggle("active", isOpen);
      document.body.classList.toggle("menu-open", isOpen);
    }

    document.querySelectorAll("nav#mainNav a").forEach((link) => {
      link.addEventListener("click", closeMobileMenu);
    });

    document.addEventListener("click", function (event) {
      const nav = document.getElementById("mainNav");
      const hamburger = document.querySelector(".hamburger");
      const ul = document.querySelector("nav#mainNav ul");
      if (!ul.classList.contains("show")) return;
      if (nav.contains(event.target) || hamburger.contains(event.target)) return;
      closeMobileMenu();
    });

    window.addEventListener("resize", function () {
      if (window.innerWidth > 768) closeMobileMenu();
    });

    confirmPopup.addEventListener("click", (event) => {
      if (event.target.id === "confirmPopup") closeConfirmPopup();
    });
    if (bookingDetailsPopup) {
      bookingDetailsPopup.addEventListener("click", (event) => {
        if (event.target.id === "bookingDetailsPopup") closeBookingDetailsPopup();
      });
    }
    if (printBookingDetailsBtn) {
      printBookingDetailsBtn.addEventListener("click", printBookingDetails);
    }
    if (closeBookingDetailsBtn) {
      closeBookingDetailsBtn.addEventListener("click", closeBookingDetailsPopup);
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && confirmPopup.classList.contains("show")) {
        closeConfirmPopup();
      }
      if (bookingDetailsPopup && event.key === "Escape" && bookingDetailsPopup.classList.contains("show")) {
        closeBookingDetailsPopup();
      }
    });

    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "index.html";
    }

    window.adminLogin = adminLogin;
    window.adminLogout = adminLogout;
    window.exportBookings = exportBookings;
    window.toggleResetPasswordForm = toggleResetPasswordForm;
    window.toggleMenu = toggleMenu;
    window.logout = logout;

document.addEventListener("DOMContentLoaded", () => {
      const userGreeting = document.getElementById("userGreeting");
      const logoutLink = document.getElementById("logoutLink");
      const loginLink = document.getElementById("loginLink");
      const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
      if (loggedInUser) {
        userGreeting.style.display = "inline";
        logoutLink.style.display = "inline";
        userGreeting.innerHTML = `<i class="fa fa-user"></i> <a href="dashboard.html" style="color: white; text-decoration: none;">Hello, ${loggedInUser.name}</a>`;
        if (loginLink) loginLink.style.display = "none";
      }

      getAdminPassword();
    });

    adminResetForm.addEventListener("submit", (event) => {
      event.preventDefault();
      clearMsg(adminResetMsg);

      const current = document.getElementById("currentAdminPassword").value;
      const next = document.getElementById("newAdminPassword").value;
      const confirm = document.getElementById("confirmAdminPassword").value;

      if (!current || !next || !confirm) {
        showMsg(adminResetMsg, "error", "Please fill all password fields.");
        return;
      }
      if (current !== getAdminPassword()) {
        showMsg(adminResetMsg, "error", "Current password is incorrect.");
        return;
      }
      if (next.length < 6) {
        showMsg(adminResetMsg, "error", "New password must be at least 6 characters.");
        return;
      }
      if (next !== confirm) {
        showMsg(adminResetMsg, "error", "New password and confirm password do not match.");
        return;
      }

      localStorage.setItem(ADMIN_PASSWORD_KEY, next);
      showMsg(adminResetMsg, "success", "Admin password updated successfully.");
      adminResetForm.reset();
    });
</script>
</body>
</html>


