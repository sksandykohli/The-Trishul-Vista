<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking | The Trishul Vista</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .booking-page {
      background:
        linear-gradient(rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.6)),
        url("images/o1.jpg") center/cover no-repeat fixed;
      min-height: 88vh;
      padding: 36px 16px 54px;
    }

    .booking-wrap {
      max-width: 1140px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.14);
      padding: 26px;
    }

    .booking-title {
      text-align: center;
      color: #102a43;
      font-family: Georgia, serif;
      margin-bottom: 8px;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
    }

    .booking-subtitle {
      text-align: center;
      color: #486581;
      margin-bottom: 22px;
    }

    .booking-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }

    .booking-layout {
      display: grid;
      grid-template-columns: 1.25fr 0.95fr;
      gap: 18px;
      align-items: start;
    }

    .booking-form-col {
      background: #ffffff;
      border: 1px solid #dce8f5;
      border-radius: 12px;
      padding: 16px;
    }

    .booking-side-col {
      background: linear-gradient(145deg, #f8fbff 0%, #eef6ff 100%);
      border: 1px solid #d5e6f7;
      border-radius: 12px;
      padding: 14px;
      position: sticky;
      top: 18px;
    }

    .side-card-title {
      margin: 0 0 8px;
      color: #0f2f52;
      font-size: 1rem;
      font-weight: 800;
    }

    .field {
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    .field label {
      color: #243b53;
      font-size: 0.92rem;
      font-weight: 700;
    }

    .req-star {
      color: #d64545;
      margin-left: 3px;
    }

    .field input,
    .field select,
    .field textarea {
      padding: 11px 12px;
      border: 1px solid #d7e1eb;
      border-radius: 8px;
      font: inherit;
      color: #102a43;
      background: #fff;
    }

    .field textarea {
      min-height: 110px;
      resize: vertical;
    }

    .field-error {
      color: #b42318;
      font-size: 0.8rem;
      margin-top: 2px;
      min-height: 1em;
      display: block;
    }

    .field-help {
      margin-top: 2px;
      color: #627d98;
      font-size: 0.78rem;
    }

    .field input.invalid,
    .field select.invalid,
    .field textarea.invalid {
      border-color: #f04438;
      box-shadow: 0 0 0 2px rgba(240, 68, 56, 0.12);
    }

    .booking-summary-box {
      margin-top: 10px;
      background: #f8fbff;
      border: 1px solid #dce8f5;
      border-radius: 10px;
      padding: 14px;
      display: grid;
      gap: 8px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      color: #334e68;
      font-size: 0.94rem;
    }

    .summary-line.total {
      font-weight: 800;
      color: #0b3a67;
      font-size: 1rem;
    }

    .status-msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.92rem;
      display: none;
    }

    .status-msg.error {
      display: block;
      background: #fff1f0;
      color: #9f1d1d;
      border: 1px solid #ffc9c5;
    }

    .status-msg.success {
      display: block;
      background: #edfdf4;
      color: #0f6a3f;
      border: 1px solid #bdeccc;
    }

    .availability-badge {
      margin-top: 4px;
      font-size: 0.86rem;
      font-weight: 700;
      color: #205493;
    }

    .policy-box {
      max-width: 980px;
      margin: 16px auto 0;
      background: #f8fbff;
      border: 1px solid #dce8f5;
      border-radius: 12px;
      padding: 18px;
      color: #243b53;
    }

    .policy-box h3 {
      margin: 0 0 10px;
      color: #102a43;
      font-size: 1.1rem;
    }

    .policy-box ul {
      margin: 0;
      padding-left: 20px;
      display: grid;
      gap: 6px;
    }

    .payment-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 7100;
      padding: 16px;
    }

    .payment-popup.show {
      display: flex;
    }

    .payment-card {
      width: min(420px, 95vw);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #dce8f5;
      box-shadow: 0 20px 38px rgba(0, 0, 0, 0.25);
      padding: 18px;
      text-align: center;
    }

    .payment-card h3 {
      margin: 0 0 8px;
      color: #102a43;
      font-size: 1.2rem;
    }

    .payment-card p {
      margin: 0 0 8px;
      color: #486581;
      font-size: 0.92rem;
    }

    .payment-amount {
      margin: 10px 0;
      color: #0b3a67;
      font-weight: 800;
      font-size: 1.05rem;
    }

    .payment-qr {
      width: 210px;
      height: 210px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #d6e5f3;
      margin: 8px auto 12px;
      display: block;
      background: #f3f7fb;
    }

    .payment-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .pay-btn {
      border: 0;
      border-radius: 8px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .pay-btn.cancel {
      background: #eef3f8;
      color: #2f4e6f;
    }

    .pay-btn.ok {
      background: #2e8abc;
      color: #fff;
    }

    .booking-success-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 7200;
      padding: 16px;
    }

    .booking-success-overlay.show {
      display: flex;
    }

    .booking-success-box {
      width: min(420px, 95vw);
      background: #ffffff;
      border: 1px solid #dce8f5;
      border-radius: 14px;
      box-shadow: 0 20px 38px rgba(0, 0, 0, 0.25);
      padding: 18px;
      text-align: center;
      color: #102a43;
    }

    .booking-success-box h3 {
      margin: 0 0 8px;
      color: #0f6a3f;
      font-size: 1.2rem;
    }

    .booking-success-box p {
      margin: 0;
      color: #486581;
      font-size: 0.92rem;
    }

    .book-btn {
      margin-top: 14px;
      width: 100%;
      border: 0;
      border-radius: 8px;
      background: #2e8abc;
      color: #fff;
      font-weight: 700;
      padding: 13px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .book-btn:hover {
      background: #2177a6;
    }

    .availability-calendar {
      margin: 6px 0 12px;
      border: 1px solid #dce8f5;
      border-radius: 10px;
      padding: 12px;
      background: #fbfdff;
    }

    .availability-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }

    .month-nav-btn {
      border: 1px solid #cdd9e6;
      background: #fff;
      color: #243b53;
      border-radius: 8px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-weight: 700;
    }

    .month-label {
      margin: 0;
      color: #102a43;
      font-size: 1rem;
      font-weight: 800;
      text-align: center;
      flex: 1;
    }

    .availability-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.85rem;
      color: #486581;
      margin-bottom: 10px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
    }

    .legend-dot.green { background: #1f9d55; }
    .legend-dot.red { background: #d64545; }
    .legend-dot.gray { background: #8fa3b8; }

    .availability-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }

    .day-header {
      text-align: center;
      font-size: 0.78rem;
      font-weight: 700;
      color: #627d98;
      padding-bottom: 4px;
    }

    .day-cell {
      border: 1px solid #deebf7;
      border-radius: 8px;
      min-height: 44px;
      background: #fff;
      color: #243b53;
      position: relative;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 700;
    }

    .day-cell.empty {
      visibility: hidden;
      pointer-events: none;
    }

    .day-cell.past {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .day-number {
      position: absolute;
      top: 6px;
      left: 7px;
      line-height: 1;
    }

    .day-dot {
      position: absolute;
      right: 7px;
      bottom: 7px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .day-dot.available { background: #1f9d55; }
    .day-dot.booked { background: #d64545; }
    .day-dot.unknown { background: #8fa3b8; }

    .day-cell.selected-start,
    .day-cell.selected-end {
      border-color: #2e8abc;
      box-shadow: inset 0 0 0 2px #2e8abc;
    }

    .day-cell.in-range {
      background: #eef8ff;
      border-color: #b9ddf2;
    }

    @media (max-width: 760px) {
      .booking-wrap {
        padding: 18px;
      }

      .booking-layout {
        grid-template-columns: 1fr;
      }

      .booking-side-col {
        position: static;
      }

      .booking-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-wrapper">
      <div class="header-logo-group">
        <img src="images/logo.png" alt="The Trishul Vista Logo" />
        <div>
          <h1>The Trishul Vista</h1>
          <p>Serenity Amongst Mountain's</p>
        </div>
      </div>

      <div class="hamburger" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
      </div>
      <nav id="mainNav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="aboutus.html">About Us</a></li>
          <li><a href="rooms.html">Rooms</a></li>
          <li><a href="booking.html" class="active">Booking</a></li>
          <li><a href="gallery.html">Gallery</a></li>
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="auth.html" id="loginLink">Login</a></li>
          <li id="userGreeting"></li>
          <li><a href="#" id="logoutLink" onclick="logout()">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="booking-page">
    <section class="booking-wrap">
      <h2 class="booking-title">Book Your Stay</h2>

      <form id="bookingForm" novalidate>
        <div class="booking-layout">
          <div class="booking-form-col">
            <div class="booking-grid">
              <div class="field">
                <label for="guestName">Guest Name<span class="req-star">*</span></label>
                <input id="guestName" name="guestName" type="text" required />
              </div>
              <div class="field">
                <label for="phone">Mobile Number<span class="req-star">*</span></label>
                <input id="phone" name="phone" type="tel" pattern="[0-9]{10}" required />
              </div>
            </div>

            <div class="booking-grid">
              <div class="field">
                <label for="email">Email Address<span class="req-star">*</span></label>
                <input id="email" name="email" type="email" required />
                <div id="accountPasswordField">
                  <label for="accountPassword">Password (Create Account)</label>
                  <input id="accountPassword" name="accountPassword" type="password" minlength="6" autocomplete="new-password" placeholder="Minimum 6 characters" />
                  <p class="field-help">If this email is not registered, an account will be created using this password.</p>
                </div>
              </div>
              <div class="field">
                <label for="address">Address<span class="req-star">*</span></label>
                <textarea id="address" name="address" required placeholder="Enter your full address"></textarea>
              </div>
            </div>

            <div class="booking-grid">
              <div class="field">
                <label for="roomType">Room Type<span class="req-star">*</span></label>
                <select id="roomType" name="roomType" required>
                  <option value="Serenity Classic Suite" selected>Serenity Classic Suite (INR 3,500/night)</option>
                  <option value="Pinewood Attic Suite">Pinewood Attic Suite (INR 5,000/night)</option>
                </select>
              </div>
              <div class="field">
                <label for="guests">No. of Guests<span class="req-star">*</span></label>
                <select id="guests" name="guests" required>
                  <option value="">Select Guests</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
            </div>

            <div class="booking-grid">
              <div class="field">
                <label for="checkIn">Check-in Date<span class="req-star">*</span></label>
                <input id="checkIn" name="checkIn" type="date" required />
              </div>
              <div class="field">
                <label for="checkOut">Check-out Date<span class="req-star">*</span></label>
                <input id="checkOut" name="checkOut" type="date" required />
              </div>
            </div>

            <div class="field">
              <label for="specialRequest">Special Request</label>
              <textarea id="specialRequest" name="specialRequest" placeholder="Any request? (optional)"></textarea>
            </div>

            <p id="statusMsg" class="status-msg"></p>
            <button class="book-btn" type="submit"><i class="fas fa-calendar-check"></i> Confirm Booking</button>
          </div>

          <aside class="booking-side-col">
            <h3 class="side-card-title"><i class="fas fa-calendar-days"></i> Availability Calendar</h3>
            <div class="availability-calendar">
              <div class="availability-head">
                <button type="button" class="month-nav-btn" id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                <p class="month-label" id="availabilityMonthLabel">Availability</p>
                <button type="button" class="month-nav-btn" id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
              </div>
              <div class="availability-legend">
                <span class="legend-item"><span class="legend-dot green"></span> Available</span>
                <span class="legend-item"><span class="legend-dot red"></span> Booked</span>
                <span class="legend-item"><span class="legend-dot gray"></span> Select room first</span>
              </div>
              <div id="availabilityGrid" class="availability-grid"></div>
              <p id="availabilityBadge" class="availability-badge"></p>
            </div>

            <div class="booking-summary-box">
              <p class="summary-line"><span>Room Charge</span><span id="roomCharge">INR 0</span></p>
              <p class="summary-line"><span>Offer Discount</span><span id="offerDiscount">0%</span></p>
              <p class="summary-line"><span>Nights</span><span id="nightCount">0</span></p>
              <p class="summary-line total"><span>Total Amount</span><span id="totalAmount">INR 0</span></p>
            </div>
          </aside>
        </div>
      </form>
    </section>
  </main>

  <div id="paymentPopup" class="payment-popup" aria-hidden="true">
    <div class="payment-card">
      <h3><i class="fas fa-qrcode"></i> Complete Advance Payment</h3>
      <p>Please scan the QR code to complete the advance payment and confirm your booking.</p>
      <p class="payment-amount" id="paymentAmountText">Advance Amount: INR 500</p>
      <img id="paymentQrImg" class="payment-qr" src="" alt="Booking Payment QR Code" />
      <p>After payment, press <strong>OK</strong>.</p>
      <div class="payment-actions">
        <button type="button" class="pay-btn cancel" id="cancelPaymentBtn">Cancel</button>
        <button type="button" class="pay-btn ok" id="confirmPaymentBtn">OK</button>
      </div>
    </div>
  </div>

  <div id="bookingSuccessOverlay" class="booking-success-overlay" aria-hidden="true">
    <div class="booking-success-box">
      <h3><i class="fas fa-circle-check"></i> Thanks for Booking!</h3>
      <p id="bookingSuccessText">Your booking is confirmed.</p>
    </div>
  </div>

  <section class="policy-box">
    <h3><i class="fa-solid fa-shield-halved"></i> Booking Policies</h3>
    <ul>
      <li>Check-in: From 1:00 PM, Check-out: By 11:00 AM.</li>
      <li>A valid government photo ID is mandatory at check-in.</li>
      <li>Only INR 500 is charged online as an advance at the time of booking confirmation.</li>
      <li>The remaining amount must be paid at the hotel property during check-in.</li>
      <li>The INR 500 booking advance is non-refundable.</li>
      <li>Property rules must be followed; additional charges may apply for damage or loss.</li>
    </ul>
  </section>

  <!-- Contact Section -->
  <div class="section-contact">
    <h2 class="contact-title"><i class="fa-solid fa-phone"></i> Contact Us</h2>
    <p class="contact-info"><i class="fa-solid fa-location-dot"></i> Vill. & Post - Peora, Distt.- Nainital, Uttarakhand 263138</p>
    <p class="contact-info"><i class="fa-solid fa-envelope"></i> thetrishulvista@gmail.com</p>
    <p class="contact-info"><i class="fa-solid fa-phone"></i> +91-7055522887, +91-7535861111</p>
    
    <div class="social-links">
      <a href="https://www.youtube.com/@thetrishulvista" target="_blank" class="social-link social-link-youtube" title="YouTube">
        <i class="fab fa-youtube"></i>
      </a>
      <a href="https://www.facebook.com/thetrishulvista/?rdid=QPI4nFDR3xsBPrRU" target="_blank" class="social-link social-link-facebook" title="Facebook">
        <i class="fab fa-facebook"></i>
      </a>
      <a href="https://www.instagram.com/thetrishulvista?igsh=MThhc3YycWx4M2Zsbw%3D%3D" target="_blank" class="social-link social-link-instagram" title="Instagram">
        <i class="fab fa-instagram"></i>
      </a>
    </div>
  </div>


  <footer>
    <p>Copyright 2025 The Trishul Vista | All rights reserved.</p>
  </footer>

  <script>
    const roomRates = {
      "Serenity Classic Suite": 3500,
      "Pinewood Attic Suite": 5000
    };
    const urlParams = new URLSearchParams(window.location.search);
    const prefilledRoom = urlParams.get("room");
    const prefilledDays = Number(urlParams.get("days")) || 0;
    const prefilledDiscount = Number(urlParams.get("discount")) || 0;

    const bookingForm = document.getElementById("bookingForm");
    const roomType = document.getElementById("roomType");
    const guests = document.getElementById("guests");
    const checkIn = document.getElementById("checkIn");
    const checkOut = document.getElementById("checkOut");
    const availabilityBadge = document.getElementById("availabilityBadge");
    const statusMsg = document.getElementById("statusMsg");
    const availabilityMonthLabel = document.getElementById("availabilityMonthLabel");
    const availabilityGrid = document.getElementById("availabilityGrid");
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");
    const paymentPopup = document.getElementById("paymentPopup");
    const paymentQrImg = document.getElementById("paymentQrImg");
    const paymentAmountText = document.getElementById("paymentAmountText");
    const cancelPaymentBtn = document.getElementById("cancelPaymentBtn");
    const confirmPaymentBtn = document.getElementById("confirmPaymentBtn");
    const bookingSuccessOverlay = document.getElementById("bookingSuccessOverlay");
    const bookingSuccessText = document.getElementById("bookingSuccessText");
    const accountPasswordInput = document.getElementById("accountPassword");
    const accountPasswordField = document.getElementById("accountPasswordField");
    const ADVANCE_PAYMENT = 500;
    const formFields = [
      document.getElementById("guestName"),
      document.getElementById("phone"),
      document.getElementById("email"),
      accountPasswordInput,
      document.getElementById("address"),
      roomType,
      guests,
      checkIn,
      checkOut
    ];
    let availabilityMonth = new Date();
    let pendingBookingData = null;
    let pendingAccountInfo = null;
    let isLoggedInBookingUser = false;

    function getTodayYMD() {
      const d = new Date();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${d.getFullYear()}-${month}-${day}`;
    }

    function parseDate(dateStr) {
      return new Date(`${dateStr}T00:00:00`);
    }

    function toYMD(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getNights() {
      if (!checkIn.value || !checkOut.value) return 0;
      const inDate = parseDate(checkIn.value);
      const outDate = parseDate(checkOut.value);
      const diff = (outDate - inDate) / (1000 * 60 * 60 * 24);
      return diff > 0 ? diff : 0;
    }

    function getOfferDiscountByNights(nights) {
      if (nights >= 5 && nights <= 9) return 50;
      if (nights >= 10 && nights <= 29) return 55;
      if (nights >= 30) return 65;
      return 0;
    }

    function rangesOverlap(startA, endA, startB, endB) {
      return startA < endB && startB < endA;
    }

    function getBookings() {
      return JSON.parse(localStorage.getItem("trishulBookings") || "[]");
    }

    function isBookingApproved(booking) {
      if (!booking) return false;
      if (!booking.approvalStatus) return true;
      return String(booking.approvalStatus).toLowerCase() === "approved";
    }

    function findConflict(selectedRoom, inDate, outDate) {
      const all = getBookings();
      return all.find((b) => {
        if (b.roomType !== selectedRoom) return false;
        if (!isBookingApproved(b)) return false;
        return rangesOverlap(inDate, outDate, parseDate(b.checkIn), parseDate(b.checkOut));
      });
    }

    function isDateBooked(selectedRoom, dateObj) {
      if (!selectedRoom) return false;
      const all = getBookings();
      return all.some((b) => {
        if (b.roomType !== selectedRoom) return false;
        if (!isBookingApproved(b)) return false;
        const start = parseDate(b.checkIn);
        const end = parseDate(b.checkOut);
        return dateObj >= start && dateObj < end;
      });
    }

    function renderAvailabilityCalendar() {
      const month = availabilityMonth.getMonth();
      const year = availabilityMonth.getFullYear();
      availabilityMonthLabel.textContent = new Date(year, month, 1).toLocaleString("en-IN", {
        month: "long",
        year: "numeric"
      });

      availabilityGrid.innerHTML = "";
      const weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      weekDays.forEach((d) => {
        const el = document.createElement("div");
        el.className = "day-header";
        el.textContent = d;
        availabilityGrid.appendChild(el);
      });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = parseDate(getTodayYMD());

      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement("button");
        empty.type = "button";
        empty.className = "day-cell empty";
        availabilityGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(year, month, day);
        const ymd = toYMD(dateObj);
        const selectedRoom = roomType.value;
        const booked = selectedRoom ? isDateBooked(selectedRoom, dateObj) : false;
        const isPast = dateObj < today;

        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "day-cell";
        if (isPast) cell.classList.add("past");
        if (checkIn.value === ymd) cell.classList.add("selected-start");
        if (checkOut.value === ymd) cell.classList.add("selected-end");
        if (checkIn.value && checkOut.value && ymd > checkIn.value && ymd < checkOut.value) {
          cell.classList.add("in-range");
        }

        const num = document.createElement("span");
        num.className = "day-number";
        num.textContent = String(day);
        cell.appendChild(num);

        const dot = document.createElement("span");
        dot.className = `day-dot ${selectedRoom ? (booked ? "booked" : "available") : "unknown"}`;
        cell.appendChild(dot);

        cell.addEventListener("click", () => {
          if (isPast) return;
          if (!roomType.value) {
            showStatus("error", "Please select a room first, then choose dates.");
            return;
          }
          clearStatus();
          if (!checkIn.value || (checkIn.value && checkOut.value)) {
            checkIn.value = ymd;
            checkOut.value = "";
          } else if (ymd <= checkIn.value) {
            checkIn.value = ymd;
          } else {
            checkOut.value = ymd;
          }
          checkOut.min = checkIn.value || getTodayYMD();
          updateSummary();
          validateAvailability();
          renderAvailabilityCalendar();
        });

        availabilityGrid.appendChild(cell);
      }
    }

    function showStatus(type, text) {
      statusMsg.className = `status-msg ${type}`;
      statusMsg.textContent = text;
    }

    function clearStatus() {
      statusMsg.className = "status-msg";
      statusMsg.textContent = "";
    }

    function ensureFieldErrorSlot(field) {
      const wrapper = field.parentElement;
      if (!wrapper) return null;
      let errorEl = wrapper.querySelector(`.field-error[data-for="${field.id}"]`);
      if (!errorEl) {
        errorEl = document.createElement("small");
        errorEl.className = "field-error";
        errorEl.dataset.for = field.id;
        wrapper.appendChild(errorEl);
      }
      return errorEl;
    }

    function setFieldError(field, message) {
      const errorEl = ensureFieldErrorSlot(field);
      if (errorEl) errorEl.textContent = message || "";
      field.classList.add("invalid");
    }

    function clearFieldError(field) {
      const errorEl = ensureFieldErrorSlot(field);
      if (errorEl) errorEl.textContent = "";
      field.classList.remove("invalid");
    }

    function validateSingleField(field) {
      const value = String(field.value || "").trim();
      const label = field.closest(".field")?.querySelector("label")?.textContent || "Field";
      let message = "";

      if (field.required && !value) {
        message = `Please fill ${label}.`;
      } else if (field.id === "phone" && !/^[0-9]{10}$/.test(value)) {
        message = "Mobile Number must be exactly 10 digits.";
      } else if (field.id === "email" && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        message = "Please enter a valid Email Address.";
      } else if (field.id === "accountPassword" && value && value.length < 6) {
        message = "Password must be at least 6 characters.";
      } else if (field.id === "checkOut" && checkIn.value && value && value <= checkIn.value) {
        message = "Check-out date must be later than check-in date.";
      }

      if (message) {
        setFieldError(field, message);
        return false;
      }
      clearFieldError(field);
      return true;
    }

    function validateAllFields() {
      let firstInvalid = null;
      formFields.forEach((field) => {
        const valid = validateSingleField(field);
        if (!valid && !firstInvalid) firstInvalid = field;
      });
      return { valid: !firstInvalid, firstInvalid };
    }

    function closePaymentPopup() {
      paymentPopup.classList.remove("show");
      paymentPopup.setAttribute("aria-hidden", "true");
      pendingBookingData = null;
      pendingAccountInfo = null;
    }

    function openPaymentPopup(booking) {
      const advanceAmount = Math.min(ADVANCE_PAYMENT, Number(booking.total || 0));
      const qrPayload = `The Trishul Vista|Booking ${booking.id}|Advance INR ${advanceAmount}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(qrPayload)}`;
      paymentAmountText.textContent = `Advance Amount: INR ${advanceAmount.toLocaleString("en-IN")} (Online)`;
      paymentQrImg.src = qrUrl;
      paymentPopup.classList.add("show");
      paymentPopup.setAttribute("aria-hidden", "false");
    }

    function finalizeBookingAfterPayment() {
      if (!pendingBookingData) return;
      const booking = pendingBookingData;
      const allBookings = getBookings();
      allBookings.push(booking);
      localStorage.setItem("trishulBookings", JSON.stringify(allBookings));

      if (pendingAccountInfo?.shouldCreate) {
        const users = JSON.parse(localStorage.getItem("registeredUsers") || "[]");
        const exists = users.some((u) => String(u.email || "").toLowerCase() === String(booking.email || "").toLowerCase());
        if (!exists) {
          users.push({
            name: booking.guestName || "",
            email: booking.email || "",
            phone: booking.phone || "",
            address: booking.address || "",
            password: pendingAccountInfo.password || ""
          });
          localStorage.setItem("registeredUsers", JSON.stringify(users));
          localStorage.setItem("loggedInUser", JSON.stringify({ name: booking.guestName || "", email: booking.email || "" }));
        }
      }

      bookingForm.reset();
      clearStatus();
      formFields.forEach(clearFieldError);
      checkOut.min = getTodayYMD();
      availabilityBadge.textContent = "";
      updateSummary();
      renderAvailabilityCalendar();
      closePaymentPopup();
      bookingSuccessText.textContent = `Thanks for booking! Booking ID: ${booking.id}. Request sent for admin approval. Redirecting to home page...`;
      bookingSuccessOverlay.classList.add("show");
      bookingSuccessOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1800);
    }

    function updateSummary() {
      const nights = getNights();
      const rate = roomRates[roomType.value] || 0;
      const offerDiscount = getOfferDiscountByNights(nights);

      let roomChargeValue = rate * nights;
      if (offerDiscount > 0) {
        roomChargeValue = Math.round(roomChargeValue * (100 - offerDiscount) / 100);
      } else if (prefilledDays > 0 && prefilledDiscount > 0 && nights === prefilledDays) {
        roomChargeValue = Math.round(roomChargeValue * (100 - prefilledDiscount) / 100);
      }

      const total = roomChargeValue;

      document.getElementById("nightCount").textContent = String(nights);
      document.getElementById("roomCharge").textContent = `INR ${roomChargeValue.toLocaleString("en-IN")}`;
      document.getElementById("offerDiscount").textContent = `${offerDiscount}%`;
      document.getElementById("totalAmount").textContent = `INR ${total.toLocaleString("en-IN")}`;
    }

    function validateAvailability() {
      availabilityBadge.textContent = "";
      if (!roomType.value || !checkIn.value || !checkOut.value) return true;

      const inDate = parseDate(checkIn.value);
      const outDate = parseDate(checkOut.value);

      if (outDate <= inDate) {
        availabilityBadge.textContent = "Check-out date must be later than check-in date.";
        availabilityBadge.style.color = "#9f1d1d";
        return false;
      }

      const conflict = findConflict(roomType.value, inDate, outDate);
      if (conflict) {
        availabilityBadge.textContent = `Not Available: This room is already booked from ${conflict.checkIn} to ${conflict.checkOut}.`;
        availabilityBadge.style.color = "#9f1d1d";
        return false;
      }

      availabilityBadge.textContent = "Available: The room is free for the selected dates.";
      availabilityBadge.style.color = "#0f6a3f";
      return true;
    }

    function initializeBookingDates() {
      const today = getTodayYMD();
      checkIn.min = today;
      checkOut.min = today;

      checkIn.addEventListener("change", () => {
        checkOut.min = checkIn.value || today;
        updateSummary();
        validateAvailability();
        renderAvailabilityCalendar();
      });
    }

    bookingForm.addEventListener("input", () => {
      clearStatus();
      formFields.forEach((field) => {
        if (field.value) validateSingleField(field);
      });
      updateSummary();
      validateAvailability();
      renderAvailabilityCalendar();
    });

    bookingForm.addEventListener("change", () => {
      clearStatus();
      formFields.forEach((field) => {
        if (field.value) validateSingleField(field);
      });
      updateSummary();
      validateAvailability();
      renderAvailabilityCalendar();
    });

    bookingForm.addEventListener("submit", (event) => {
      event.preventDefault();
      clearStatus();
      pendingAccountInfo = null;

      const formState = validateAllFields();
      if (!formState.valid) {
        showStatus("error", "Please fill the highlighted fields.");
        formState.firstInvalid.focus();
        return;
      }

      const today = parseDate(getTodayYMD());
      const inDate = parseDate(checkIn.value);
      const outDate = parseDate(checkOut.value);
      if (inDate < today) {
        setFieldError(checkIn, "Past-date booking is not allowed.");
        showStatus("error", "Past-date booking is not allowed.");
        checkIn.focus();
        return;
      }
      if (outDate <= inDate) {
        setFieldError(checkOut, "Check-out date must be later than check-in date.");
        showStatus("error", "Check-out date must be later than check-in date.");
        checkOut.focus();
        return;
      }
      if (!validateAvailability()) {
        showStatus("error", "The selected room is not available for these dates.");
        return;
      }

      const bookingEmail = String(document.getElementById("email").value || "").trim().toLowerCase();
      const accountPassword = String(accountPasswordInput.value || "").trim();
      const users = JSON.parse(localStorage.getItem("registeredUsers") || "[]");
      const emailRegistered = users.some((u) => String(u.email || "").toLowerCase() === bookingEmail);

      if (!emailRegistered) {
        if (isLoggedInBookingUser) {
          clearFieldError(accountPasswordInput);
          pendingAccountInfo = { shouldCreate: false, password: "" };
        } else {
          if (accountPassword.length < 6) {
            setFieldError(accountPasswordInput, "To create an account, password must be at least 6 characters.");
            showStatus("error", "Please set a password to create your account.");
            accountPasswordInput.focus();
            return;
          }
          clearFieldError(accountPasswordInput);
          pendingAccountInfo = { shouldCreate: true, password: accountPassword };
        }
      } else {
        if (accountPassword && accountPassword.length < 6) {
          setFieldError(accountPasswordInput, "Password must be at least 6 characters.");
          showStatus("error", "Please enter a valid password or leave this field empty.");
          accountPasswordInput.focus();
          return;
        }
        clearFieldError(accountPasswordInput);
        pendingAccountInfo = { shouldCreate: false, password: "" };
      }

      const rate = roomRates[roomType.value];
      const nights = getNights();
      const guestCount = Number(guests.value);
      const offerDiscount = getOfferDiscountByNights(nights);
      let roomCharge = rate * nights;
      if (offerDiscount > 0) {
        roomCharge = Math.round(roomCharge * (100 - offerDiscount) / 100);
      } else if (prefilledDays > 0 && prefilledDiscount > 0 && nights === prefilledDays) {
        roomCharge = Math.round(roomCharge * (100 - prefilledDiscount) / 100);
      }
      const total = roomCharge;

      const allBookings = getBookings();
      const maxBookingNo = allBookings.reduce((max, b) => {
        const num = Number(b.bookingNo || 0);
        return num > max ? num : max;
      }, 0);
      const nextBookingNo = maxBookingNo + 1;
      const createdAt = Date.now();

      const booking = {
        bookingNo: nextBookingNo,
        id: `TV-${Date.now()}`,
        guestName: document.getElementById("guestName").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: document.getElementById("email").value.trim(),
        address: document.getElementById("address").value.trim(),
        roomType: roomType.value,
        guests: guestCount,
        checkIn: checkIn.value,
        checkOut: checkOut.value,
        specialRequest: document.getElementById("specialRequest").value.trim(),
        nights,
        offerDiscount,
        total,
        createdAt
      };

      const advancePaid = Math.min(ADVANCE_PAYMENT, total);
      booking.advancePaid = advancePaid;
      booking.balanceDue = Math.max(total - advancePaid, 0);
      booking.paymentStatus = "Advance Paid";
      booking.paymentMethod = "QR";
      booking.paymentAt = new Date().toISOString();
      booking.approvalStatus = "Pending";
      booking.approvedAt = "";

      pendingBookingData = booking;
      openPaymentPopup(booking);
    });

    cancelPaymentBtn.addEventListener("click", closePaymentPopup);
    confirmPaymentBtn.addEventListener("click", finalizeBookingAfterPayment);

    paymentPopup.addEventListener("click", (event) => {
      if (event.target.id === "paymentPopup") closePaymentPopup();
    });

    document.addEventListener("DOMContentLoaded", () => {
      initializeBookingDates();
      updateSummary();

      if (prefilledRoom && roomRates[prefilledRoom]) {
        roomType.value = prefilledRoom;
      }
      if (prefilledDays > 0) {
        const inDate = new Date();
        const outDate = new Date();
        outDate.setDate(inDate.getDate() + prefilledDays);
        checkIn.value = getTodayYMD();
        checkOut.value = `${outDate.getFullYear()}-${String(outDate.getMonth() + 1).padStart(2, "0")}-${String(outDate.getDate()).padStart(2, "0")}`;
        checkOut.min = checkIn.value;
      }
      updateSummary();
      validateAvailability();
      availabilityMonth = new Date(parseDate(getTodayYMD()).getFullYear(), parseDate(getTodayYMD()).getMonth(), 1);
      renderAvailabilityCalendar();

      prevMonthBtn.addEventListener("click", () => {
        availabilityMonth = new Date(availabilityMonth.getFullYear(), availabilityMonth.getMonth() - 1, 1);
        renderAvailabilityCalendar();
      });

      nextMonthBtn.addEventListener("click", () => {
        availabilityMonth = new Date(availabilityMonth.getFullYear(), availabilityMonth.getMonth() + 1, 1);
        renderAvailabilityCalendar();
      });

      const userGreeting = document.getElementById("userGreeting");
      const logoutLink = document.getElementById("logoutLink");
      const loginLink = document.getElementById("loginLink");
      const registerLink = document.getElementById("registerLink");
      const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

      if (loggedInUser) {
        isLoggedInBookingUser = true;
        userGreeting.style.display = "inline";
        logoutLink.style.display = "inline";
        userGreeting.innerHTML = `<i class="fa fa-user"></i> <a href="dashboard.html" style="color: white; text-decoration: none;">Hello, ${loggedInUser.name}</a>`;
        if (loginLink) loginLink.style.display = "none";
        if (registerLink) registerLink.style.display = "none";

        const users = JSON.parse(localStorage.getItem("registeredUsers") || "[]");
        const userProfile = users.find((u) => String(u.email || "").toLowerCase() === String(loggedInUser.email || "").toLowerCase());
        const source = userProfile || loggedInUser;

        document.getElementById("guestName").value = source.name || "";
        document.getElementById("phone").value = source.phone || "";
        document.getElementById("email").value = source.email || loggedInUser.email || "";
        document.getElementById("address").value = source.address || "";

        accountPasswordField.style.display = "none";
        accountPasswordInput.value = "";
        clearFieldError(accountPasswordInput);
      }
    });

    function closeMobileMenu() {
      const ul = document.querySelector("nav#mainNav ul");
      const hamburger = document.querySelector(".hamburger");
      ul.classList.remove("show");
      hamburger.classList.remove("active");
      document.body.classList.remove("menu-open");
    }

    function toggleMenu() {
      const ul = document.querySelector("nav#mainNav ul");
      const hamburger = document.querySelector(".hamburger");
      const isOpen = ul.classList.toggle("show");
      hamburger.classList.toggle("active", isOpen);
      document.body.classList.toggle("menu-open", isOpen);
    }

    document.querySelectorAll("nav#mainNav a").forEach((link) => {
      link.addEventListener("click", closeMobileMenu);
    });

    document.addEventListener("click", function (event) {
      const nav = document.getElementById("mainNav");
      const hamburger = document.querySelector(".hamburger");
      const ul = document.querySelector("nav#mainNav ul");
      if (!ul.classList.contains("show")) return;
      if (nav.contains(event.target) || hamburger.contains(event.target)) return;
      closeMobileMenu();
    });

    window.addEventListener("resize", function () {
      if (window.innerWidth > 768) closeMobileMenu();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && paymentPopup.classList.contains("show")) {
        closePaymentPopup();
      }
    });

    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "index.html";
    }

    (function trackSiteVisit() {
      const analyticsKey = "trishulVisitorAnalytics";
      const visitorIdKey = "trishulVisitorId";
      const now = Date.now();
      const today = new Date().toISOString().slice(0, 10);
      const currentPage = window.location.pathname.split("/").pop() || "index.html";

      let analytics = JSON.parse(localStorage.getItem(analyticsKey) || "{}");
      if (!analytics || typeof analytics !== "object") analytics = {};

      analytics.totalVisits = Number(analytics.totalVisits || 0) + 1;
      analytics.dailyVisits = analytics.dailyVisits || {};
      analytics.dailyVisits[today] = Number(analytics.dailyVisits[today] || 0) + 1;
      analytics.pageVisits = analytics.pageVisits || {};
      analytics.pageVisits[currentPage] = Number(analytics.pageVisits[currentPage] || 0) + 1;

      let visitorId = localStorage.getItem(visitorIdKey);
      if (!visitorId) {
        visitorId = `V-${Math.random().toString(36).slice(2, 8)}-${Date.now()}`;
        localStorage.setItem(visitorIdKey, visitorId);
      }

      analytics.uniqueVisitors = analytics.uniqueVisitors || {};
      const existingVisitor = analytics.uniqueVisitors[visitorId] || {
        firstSeen: now,
        lastSeen: now,
        visits: 0
      };
      existingVisitor.lastSeen = now;
      existingVisitor.visits = Number(existingVisitor.visits || 0) + 1;
      analytics.uniqueVisitors[visitorId] = existingVisitor;
      analytics.lastVisitAt = now;

      localStorage.setItem(analyticsKey, JSON.stringify(analytics));
    })();
</script>
</body>
</html>



